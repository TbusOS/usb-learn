# Linux USB内核架构详解

## 📌 文档组织思路

本文档按照"**整体框架 → 子系统细化 → 数据结构关系 → 接口详解**"的顺序组织，帮助您逐层深入理解Linux USB内核架构。

## 1. Linux USB子系统整体框架

### 1.1 USB子系统在内核中的位置（最高层视图）

```
┌────────────────────────────────────────────────────────────────────────────┐
│                           Linux内核空间                                     │
├──────────────────────┬──────────────────────┬──────────────────────────────┤
│     进程管理         │      内存管理        │         文件系统             │
├──────────────────────┼──────────────────────┼──────────────────────────────┤
│                      │                      │                              │
│   网络子系统         │   ★ USB子系统 ★     │        块设备子系统          │
│                      │                      │                              │
├──────────────────────┼──────────────────────┼──────────────────────────────┤
│     字符设备         │     平台设备         │         PCI子系统            │
├──────────────────────┴──────────────────────┴──────────────────────────────┤
│                          硬件抽象层（HAL）                                  │
├────────────────────────────────────────────────────────────────────────────┤
│                          中断处理 / DMA / I/O                               │
└────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌────────────────────────────────────────────────────────────────────────────┐
│                           硬件层                                            │
└────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 Linux USB子系统完整架构（核心视图）

```
                        Linux USB子系统架构
┌────────────────────────────────────────────────────────────────────────────┐
│                           用户空间                                          │
├──────────────────┬──────────────────┬──────────────────┬──────────────────┤
│  应用程序        │    libusb库      │   sysfs接口      │   usbfs接口      │
└──────────────────┴──────────────────┴──────────────────┴──────────────────┘
                   ▲                   ▲                   ▲
═══════════════════╬═══════════════════╬═══════════════════╬══════════ 系统调用
                   ▼                   ▼                   ▼
┌────────────────────────────────────────────────────────────────────────────┐
│                         USB设备驱动层                                       │
├──────────────────┬──────────────────┬──────────────────┬──────────────────┤
│  USB存储驱动     │   USB HID驱动    │  USB网络驱动    │  其他设备驱动    │
│ (usb-storage)    │   (usbhid)       │  (usbnet)        │                  │
└──────────────────┴──────────────────┴──────────────────┴──────────────────┘
                                ▲
                                │ [probe/disconnect]
                                ▼
┌────────────────────────────────────────────────────────────────────────────┐
│                         USB Core (USB核心层)                                │
├──────────────────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐     │
│  │ 设备管理器   │ │  驱动管理器  │ │  URB管理器   │ │  Hub驱动     │     │
│  │              │ │              │ │              │ │              │     │
│  │ ·设备枚举   │ │ ·驱动注册   │ │ ·URB分配    │ │ ·端口管理   │     │
│  │ ·设备配置   │ │ ·驱动匹配   │ │ ·URB提交    │ │ ·设备检测   │     │
│  │ ·电源管理   │ │ ·probe调用   │ │ ·URB完成    │ │ ·速度检测   │     │
│  └──────────────┘ └──────────────┘ └──────────────┘ └──────────────┘     │
│                                                                             │
│  核心API: usb_register_driver(), usb_submit_urb(), usb_control_msg()      │
└────────────────────────────────────────────────────────────────────────────┘
                                ▲
                                │ [HCD接口]
                                ▼
┌────────────────────────────────────────────────────────────────────────────┐
│                    主机控制器驱动层 (HCD Layer)                             │
├──────────────────┬──────────────────┬──────────────────┬──────────────────┤
│   EHCI驱动       │    XHCI驱动      │   OHCI驱动      │   UHCI驱动       │
│  (USB 2.0)       │   (USB 3.0)      │  (USB 1.1)      │  (USB 1.1)       │
└──────────────────┴──────────────────┴──────────────────┴──────────────────┘
                                ▲
                                │ [硬件寄存器操作]
                                ▼
┌────────────────────────────────────────────────────────────────────────────┐
│                         USB主机控制器硬件                                   │
└────────────────────────────────────────────────────────────────────────────┘
```

## 2. USB Core层详细架构

### 2.1 USB Core内部模块关系

```
                            USB Core内部架构
┌────────────────────────────────────────────────────────────────────────────┐
│                              USB Core                                       │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐  │
│  │                        设备管理模块                                   │  │
│  ├──────────────────┬──────────────────┬────────────────────────────────┤  │
│  │  usb_device结构  │  设备枚举器      │      配置管理器              │  │
│  │     管理器       │                  │                              │  │
│  └──────────────────┴──────────────────┴────────────────────────────────┘  │
│                     ▲                   ▲                                  │
│                     │                   │                                  │
│  ┌──────────────────┼───────────────────┼──────────────────────────────┐  │
│  │                  │    接口管理模块    │                              │  │
│  ├──────────────────┼──────────────────┬┼────────────────────────────────┤  │
│  │ usb_interface    │                  ││        端点管理器           │  │
│  │    管理器        │                  ▼▼                              │  │
│  └──────────────────┼──────────────────────────────────────────────────┘  │
│                     │                                                      │
│  ┌──────────────────▼───────────────────────────────────────────────────┐  │
│  │                        URB处理模块                                    │  │
│  ├──────────────────┬──────────────────┬────────────────────────────────┤  │
│  │   URB分配器      │   URB调度器      │      URB完成处理器           │  │
│  │                  │                  │                              │  │
│  │  ·内存管理       │  ·队列管理       │      ·回调处理              │  │
│  │  ·初始化         │  ·优先级调度     │      ·错误处理              │  │
│  └──────────────────┴──────────────────┴────────────────────────────────┘  │
│                                ▲                                           │
│                                │                                           │
│  ┌─────────────────────────────▼────────────────────────────────────────┐  │
│  │                        HCD接口模块                                    │  │
│  ├──────────────────┬──────────────────┬────────────────────────────────┤  │
│  │   HCD注册管理    │   传输调度器     │      中断处理器              │  │
│  └──────────────────┴──────────────────┴────────────────────────────────┘  │
│                                                                             │
└────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 USB设备枚举详细流程

```
                        设备枚举过程内部细节
                        
   Hub中断处理                USB Core处理              设备响应
       │                           │                        │
       ▼                           ▼                        ▼
┌──────────────┐          ┌──────────────────┐    ┌──────────────┐
│  端口状态变化 │ ───────> │   hub_event()    │    │              │
│              │          │                  │    │              │
│  设备插入检测 │          │  1. 读端口状态   │    │   设备上电    │
└──────────────┘          │                  │    │              │
                          │  2. 端口复位     │───>│   收到复位    │
                          │     (10ms)       │    │              │
                          │                  │    │  进入Default │
                          │  3. 获取速度     │<───│   状态       │
                          │                  │    │              │
                          │  4. 分配设备结构 │    │              │
                          │     usb_device   │    │              │
                          │                  │    │              │
                          │  5. 获取设备    │───>│  返回设备    │
                          │     描述符(8字节)│<───│  描述符      │
                          │                  │    │              │
                          │  6. 再次复位     │───>│   复位       │
                          │                  │    │              │
                          │  7. 设置地址     │───>│  保存地址    │
                          │     SET_ADDRESS  │<───│     ACK      │
                          │                  │    │              │
                          │  8. 获取完整     │───>│  返回完整    │
                          │     设备描述符   │<───│  设备描述符  │
                          │                  │    │              │
                          │  9. 获取配置     │───>│  返回配置    │
                          │     描述符       │<───│  描述符集    │
                          │                  │    │              │
                          │ 10. 解析描述符   │    │              │
                          │     创建接口结构 │    │              │
                          │                  │    │              │
                          │ 11. 设置配置     │───>│  进入        │
                          │  SET_CONFIG      │<───│ Configured   │
                          │                  │    │    状态      │
                          │ 12. 驱动匹配     │    │              │
                          │     调用probe    │    │              │
                          └──────────────────┘    └──────────────┘
```

## 3. USB核心数据结构关系

### 3.1 主要数据结构总览

```
                     Linux USB核心数据结构关系图
                     
┌─────────────────────────────────────────────────────────────────────────┐
│                          struct usb_device                              │
│ USB设备结构 - 代表一个物理USB设备                                        │
├─────────────────────────────────────────────────────────────────────────┤
│ + int devnum                    // 设备号                               │
│ + enum usb_device_speed speed   // 设备速度                             │
│ + struct usb_device *parent     // 父设备(Hub)                          │
│ + struct usb_bus *bus           // 所属总线                             │
│ + struct usb_device_descriptor  // 设备描述符                           │
│ + struct usb_host_config *config// 配置数组                             │
│ + struct usb_host_endpoint *ep0 // 端点0                                │
└─────────────────────────────────────────────────────────────────────────┘
                    │                           │
                    │ 1:N                       │ 1:N
                    ▼                           ▼
┌──────────────────────────────┐  ┌──────────────────────────────────────┐
│ struct usb_host_config       │  │     struct usb_interface             │
│ USB配置结构                   │  │     USB接口结构                       │
├──────────────────────────────┤  ├──────────────────────────────────────┤
│ + struct usb_config_desc     │  │ + struct usb_host_interface          │
│ + struct usb_interface       │  │   *altsetting  // 备用设置数组        │
│   *interface[]                │  │ + struct usb_host_interface          │
│ + int num_interfaces          │  │   *cur_altsetting // 当前设置         │
└──────────────────────────────┘  │ + struct usb_driver *driver          │
                                   └──────────────────────────────────────┘
                                                    │
                                                    │ 1:N
                                                    ▼
                                   ┌──────────────────────────────────────┐
                                   │  struct usb_host_endpoint            │
                                   │  USB端点结构                          │
                                   ├──────────────────────────────────────┤
                                   │ + struct usb_endpoint_descriptor     │
                                   │   desc         // 端点描述符          │
                                   │ + struct list_head urb_list          │
                                   │                // URB链表             │
                                   └──────────────────────────────────────┘
```

### 3.2 URB (USB Request Block) 结构详解

```
                        URB数据结构及其关系
                        
┌─────────────────────────────────────────────────────────────────────────┐
│                            struct urb                                    │
│                      USB请求块 - 数据传输的核心                           │
├─────────────────────────────────────────────────────────────────────────┤
│ /* 基本信息 */                                                           │
│ + struct kref kref              // 引用计数                              │
│ + void *hcpriv                  // HCD私有数据                           │
│ + struct list_head urb_list     // URB链表节点                           │
│                                                                          │
│ /* 目标设备和端点 */                                                      │
│ + struct usb_device *dev ──────────┐                                    │
│ + unsigned int pipe                │                                    │
│ + struct usb_host_endpoint *ep ────┼───┐                                │
│                                    │   │                                │
│ /* 数据缓冲区 */                    │   │                                │
│ + void *transfer_buffer            │   │                                │
│ + dma_addr_t transfer_dma          │   │                                │
│ + u32 transfer_buffer_length       │   │                                │
│ + u32 actual_length                │   │                                │
│                                    │   │                                │
│ /* 控制传输专用 */                  │   │                                │
│ + unsigned char *setup_packet      │   │                                │
│                                    │   │                                │
│ /* 完成处理 */                      │   │                                │
│ + usb_complete_t complete          │   │                                │
│ + void *context                    │   │                                │
│ + int status                       │   │                                │
└────────────────────────────────────┼───┼────────────────────────────────┘
                                     │   │
                    ┌────────────────┘   └──────────────┐
                    ▼                                    ▼
       ┌──────────────────────┐            ┌──────────────────────┐
       │  struct usb_device   │            │struct usb_host_endpoint│
       │                      │            │                      │
       │  目标USB设备          │            │  目标端点             │
       └──────────────────────┘            └──────────────────────┘
```

### 3.3 USB驱动结构关系

```
                        USB驱动注册和匹配机制
                        
┌─────────────────────────────────────────────────────────────────────────┐
│                        struct usb_driver                                 │
│                           USB驱动结构                                    │
├─────────────────────────────────────────────────────────────────────────┤
│ + const char *name              // 驱动名称                              │
│ + int (*probe)()                // 设备探测函数                          │
│ + void (*disconnect)()          // 设备断开函数                          │
│ + const struct usb_device_id    // 设备ID表                             │
│   *id_table ────────────────────────┐                                   │
│ + struct usb_dynids dynids      // 动态ID                               │
│ + struct device_driver driver   // 基础驱动结构                         │
└─────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
                    ┌─────────────────────────────────────┐
                    │   struct usb_device_id              │
                    │        设备ID匹配表                  │
                    ├─────────────────────────────────────┤
                    │ + __u16 match_flags                 │
                    │ + __u16 idVendor      ──────┐       │
                    │ + __u16 idProduct     ──────┼───┐   │
                    │ + __u8 bDeviceClass         │   │   │
                    │ + __u8 bInterfaceClass      │   │   │
                    └─────────────────────────────┼───┼───┘
                                                  │   │
                         匹配过程：                │   │
                                                  ▼   ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                          设备枚举后的匹配流程                             │
│                                                                          │
│   usb_device->descriptor.idVendor == id_table->idVendor ?               │
│   usb_device->descriptor.idProduct == id_table->idProduct ?             │
│                                ↓                                         │
│                          调用 driver->probe()                            │
└─────────────────────────────────────────────────────────────────────────┘
```

## 4. HCD (Host Controller Driver) 架构

### 4.1 HCD层架构

```
                    主机控制器驱动(HCD)架构
                    
┌─────────────────────────────────────────────────────────────────────────┐
│                          struct usb_hcd                                  │
│                      USB主机控制器驱动结构                                │
├─────────────────────────────────────────────────────────────────────────┤
│ + struct usb_bus self           // 代表的USB总线                         │
│ + struct kref kref              // 引用计数                              │
│ + const char *product_desc      // 产品描述                              │
│                                                                          │
│ + struct hc_driver *driver ─────────┐   // HCD驱动操作集                 │
│                                     │                                    │
│ + unsigned long hcd_priv[]         │   // 私有数据                       │
│                                     │                                    │
│ + struct usb_phy *usb_phy          │   // USB PHY                       │
│ + struct phy *phy                  │   // 通用PHY                       │
└─────────────────────────────────────┼───────────────────────────────────┘
                                      │
                                      ▼
              ┌───────────────────────────────────────────────┐
              │           struct hc_driver                     │
              │         主机控制器驱动操作集                    │
              ├───────────────────────────────────────────────┤
              │ /* 基本操作 */                                 │
              │ + int (*start)(struct usb_hcd *)              │
              │ + void (*stop)(struct usb_hcd *)              │
              │ + int (*reset)(struct usb_hcd *)              │
              │                                               │
              │ /* URB操作 */                                 │
              │ + int (*urb_enqueue)(...)                     │
              │ + int (*urb_dequeue)(...)                     │
              │ + void (*endpoint_disable)(...)               │
              │                                               │
              │ /* Hub操作 */                                 │
              │ + int (*hub_status_data)(...)                 │
              │ + int (*hub_control)(...)                     │
              │                                               │
              │ /* 电源管理 */                                │
              │ + int (*bus_suspend)(...)                    │
              │ + int (*bus_resume)(...)                     │
              └───────────────────────────────────────────────┘
                                │
                ┌───────────────┼────────────────┬──────────────┐
                ▼               ▼                ▼              ▼
        ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
        │  EHCI HCD   │ │  XHCI HCD   │ │  OHCI HCD   │ │  UHCI HCD   │
        │             │ │             │ │             │ │             │
        │  USB 2.0    │ │  USB 3.0    │ │  USB 1.1    │ │  USB 1.1    │
        └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘
```

### 4.2 URB在HCD中的处理流程

```
                    URB在HCD层的处理流程
                    
     USB设备驱动                USB Core               HCD层
         │                         │                     │
         ▼                         ▼                     ▼
    ┌──────────┐            ┌──────────────┐     ┌──────────────┐
    │创建URB   │            │              │     │              │
    │填充参数  │ ─────────> │ usb_submit_  │     │              │
    │         │            │    urb()     │     │              │
    └──────────┘            │              │     │              │
                           │  1.参数检查  │     │              │
                           │  2.引用计数  │     │              │
                           │              │     │              │
                           │  3.调用HCD   │────>│ urb_enqueue()│
                           │              │     │              │
                           └──────────────┘     │  1.分配资源  │
                                                │  2.设置DMA   │
                                                │  3.加入队列  │
                                                │  4.启动传输  │
                                                │              │
                                                │    硬件中断  │
                                                │      ↓       │
                                                │  中断处理    │
                                                │      ↓       │
                                                │ giveback_urb │
                                                │      │       │
                                                └──────┼───────┘
                                                       │
                                                       ▼
                                                ┌──────────────┐
                                                │ URB完成回调   │
                                                │              │
                                                │ complete()   │
                                                └──────────────┘
```

## 5. USB电源管理架构

### 5.1 USB电源管理层次

```
                    USB电源管理架构
                    
┌─────────────────────────────────────────────────────────────────────────┐
│                         系统电源管理(PM)                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   系统挂起(S3/S4) ──────┐                    ┌────── 运行时PM           │
│                        │                    │                           │
└────────────────────────┼────────────────────┼───────────────────────────┘
                         │                    │
                         ▼                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         USB电源管理                                       │
├───────────────────┬─────────────────┬─────────────────┬─────────────────┤
│                   │                 │                 │                 │
│   总线挂起         │   选择性挂起    │    自动挂起     │   远程唤醒       │
│   bus_suspend()   │  selective      │  autosuspend   │  remote wakeup  │
│                   │  suspend        │                │                 │
└───────────────────┴─────────────────┴─────────────────┴─────────────────┘
                    │                 │                 │
                    ▼                 ▼                 ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                       USB设备状态                                         │
├──────────────┬──────────────┬──────────────┬──────────────┬────────────┤
│   Active     │   Idle       │  Suspended   │   Resume     │  Error     │
│   活跃       │   空闲       │    挂起      │    恢复      │   错误     │
└──────────────┴──────────────┴──────────────┴──────────────┴────────────┘
                                      │
                                      ▼
                            ┌──────────────────┐
                            │   设备电源状态    │
                            ├──────────────────┤
                            │ D0 - 全功率      │
                            │ D1 - 低功率      │
                            │ D2 - 更低功率    │
                            │ D3 - 挂起       │
                            └──────────────────┘
```

## 6. USB调试接口架构

### 6.1 USB调试和监控接口

```
                    USB调试接口架构
                    
                        用户空间工具
    ┌──────────┬──────────┬──────────┬──────────┬──────────┐
    │  lsusb   │ usbmon   │ usbview  │ wireshark│ 自定义   │
    └──────────┴──────────┴──────────┴──────────┴──────────┘
         │           │           │           │           │
         ▼           ▼           ▼           ▼           ▼
    ┌─────────────────────────────────────────────────────┐
    │                    文件系统接口                       │
    ├──────────┬──────────┬──────────┬──────────┬────────┤
    │  sysfs   │  debugfs │  procfs  │  usbfs   │ devfs  │
    │          │          │          │          │        │
    │ /sys/bus│ /sys/    │ /proc/   │ /proc/   │ /dev/  │
    │ /usb/   │ kernel/  │ bus/usb/ │ bus/usb/ │ bus/   │
    │         │ debug/   │          │          │ usb/   │
    └──────────┴──────────┴──────────┴──────────┴────────┘
              │                    │
              ▼                    ▼
    ┌────────────────────────────────────────────────────┐
    │               内核调试接口                          │
    ├──────────────────┬──────────────────┬──────────────┤
    │                  │                  │              │
    │   设备信息导出    │   URB跟踪       │   错误日志    │
    │                  │   (usbmon)      │   (dmesg)   │
    │                  │                  │              │
    │ · 设备描述符     │ · URB提交       │ · 错误信息   │
    │ · 配置信息      │ · URB完成       │ · 警告信息   │
    │ · 接口信息      │ · 数据内容      │ · 调试信息   │
    │ · 端点信息      │ · 时间戳        │              │
    └──────────────────┴──────────────────┴──────────────┘
```

## 7. USB子系统初始化流程

### 7.1 内核启动时USB子系统初始化

```
                内核USB子系统初始化流程
                
    内核启动
       │
       ▼
┌──────────────────────────────────────────────────────────┐
│  start_kernel()                                          │
│      │                                                   │
│      └─> rest_init()                                     │
│              │                                            │
│              └─> kernel_init()                           │
│                      │                                    │
│                      └─> do_initcalls()                  │
└──────────────────────────────────────────────────────────┘
                            │
                            ▼
                ┌───────────────────────┐
                │   USB子系统初始化      │
                │   subsys_initcall()   │
                └───────────────────────┘
                            │
        ┌───────────────────┼───────────────────┐
        ▼                   ▼                   ▼
┌──────────────┐   ┌──────────────┐   ┌──────────────┐
│ usb_init()   │   │ usb_hub_init()│   │ usb_register_│
│              │   │              │   │ device_driver│
│ 1.注册总线   │   │ 1.创建Hub    │   │              │
│   类型       │   │   线程       │   │ 注册USB      │
│              │   │              │   │ 设备驱动     │
│ 2.创建sysfs │   │ 2.注册Hub    │   │              │
│   目录       │   │   驱动       │   │              │
│              │   │              │   │              │
│ 3.注册主设备 │   │ 3.初始化     │   │              │
│   号         │   │   工作队列   │   │              │
└──────────────┘   └──────────────┘   └──────────────┘
                            │
                            ▼
                ┌───────────────────────┐
                │    HCD驱动初始化       │
                │  device_initcall()    │
                ├───────────────────────┤
                │ ehci_hcd_init()       │
                │ xhci_hcd_init()       │
                │ ohci_hcd_init()       │
                └───────────────────────┘
                            │
                            ▼
                    USB子系统就绪
```

## 8. 关键函数调用关系

### 8.1 设备驱动probe调用链

```
              驱动probe函数调用链
              
    设备插入
       │
       ▼
hub_event() [Hub检测到设备]
       │
       └──> hub_port_connect()
               │
               └──> usb_new_device()
                       │
                       ├──> usb_enumerate_device()
                       │        │
                       │        ├──> usb_get_descriptor()
                       │        └──> usb_get_configuration()
                       │
                       └──> device_add()
                               │
                               └──> bus_probe_device()
                                       │
                                       └──> device_attach()
                                               │
                                               └──> __device_attach()
                                                       │
                                                       └──> driver_probe_device()
                                                               │
                                                               └──> really_probe()
                                                                       │
                                                                       └──> usb_probe_interface()
                                                                               │
                                                                               └──> driver->probe()
                                                                                        │
                                                                                        ▼
                                                                                  您的驱动probe函数
```

## 总结

通过这些详细的ASCII架构图，我们展示了：

1. **整体框架**：USB子系统在内核中的位置和层次结构
2. **核心架构**：USB Core的内部模块和功能划分
3. **数据结构**：主要数据结构及其相互关系
4. **HCD架构**：主机控制器驱动的结构和操作
5. **处理流程**：URB处理、设备枚举等关键流程
6. **子系统功能**：电源管理、调试接口等
7. **初始化流程**：系统启动时的初始化顺序

这种从整体到细节的展示方式，帮助您：
- 建立USB子系统的全局视图
- 理解各组件的职责和交互
- 掌握关键数据结构的用法
- 了解驱动开发的切入点
