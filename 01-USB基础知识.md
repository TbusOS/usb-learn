# USB基础知识详解

## 1. USB简介

### 1.1 什么是USB？
**USB (Universal Serial Bus，通用串行总线)** 是一种用于连接计算机和外部设备的工业标准。它定义了连接器、电缆和通信协议的规范。

### 1.2 USB的优势
- **即插即用**：设备连接后自动识别和配置
- **热插拔**：无需关机即可连接或断开设备
- **供电能力**：可为设备提供电源（5V，最大500mA-3A）
- **标准化**：统一的接口和协议
- **可扩展**：通过Hub支持多达127个设备
- **传输可靠**：内置错误检测和纠正机制

## 2. USB发展历史

| 版本 | 发布年份 | 最大速率 | 别名 | 主要特性 |
|------|---------|----------|------|----------|
| USB 1.0 | 1996 | 1.5 Mbps | Low Speed | 初始版本 |
| USB 1.1 | 1998 | 12 Mbps | Full Speed | 修复1.0的问题 |
| USB 2.0 | 2000 | 480 Mbps | High Speed | 大幅提升速度 |
| USB 3.0 | 2008 | 5 Gbps | SuperSpeed | 全双工传输 |
| USB 3.1 | 2013 | 10 Gbps | SuperSpeed+ | 更高速率 |
| USB 3.2 | 2017 | 20 Gbps | SuperSpeed+ | 多通道技术 |
| USB4 | 2019 | 40 Gbps | - | 基于雷电3协议 |

## 3. USB系统架构

### 3.1 物理拓扑结构
```
         主机（Host）
              |
         Root Hub
         /    |    \
      Hub   设备   Hub
      / \         /  \
   设备 设备   设备  设备
```

### 3.2 逻辑拓扑结构
- **分层星型拓扑**：以Root Hub为中心
- **最多7层**：包括Root Hub
- **最多127个设备**：地址0保留，主机占用地址1-127

### 3.3 USB系统组成
1. **USB主机（Host）**
   - 发起所有传输
   - 管理USB总线
   - 提供电源

2. **USB设备（Device）**
   - 响应主机请求
   - 提供功能服务
   - 可自供电或总线供电

3. **USB Hub**
   - 扩展USB端口
   - 信号中继和放大
   - 电源分配

## 4. USB电气特性

### 4.1 USB线缆结构
```
USB 2.0 线缆（4线）：
- VBUS (红色)：+5V电源
- D+ (绿色)：差分数据正
- D- (白色)：差分数据负  
- GND (黑色)：地线

USB 3.0+ 额外增加：
- SSTX+/- ：SuperSpeed发送差分对
- SSRX+/- ：SuperSpeed接收差分对
```

### 4.2 速度识别机制
设备通过在D+或D-线上的上拉电阻来标识速度：
- **低速设备**：D-上拉1.5kΩ到3.3V
- **全速设备**：D+上拉1.5kΩ到3.3V
- **高速设备**：先按全速连接，然后协商切换到高速

### 4.3 信号电平
- **差分1（J状态）**：D+ > 2.8V, D- < 0.3V
- **差分0（K状态）**：D+ < 0.3V, D- > 2.8V
- **单端0（SE0）**：D+ < 0.3V, D- < 0.3V

## 5. USB通信原理

### 5.1 主从模型
- USB采用**主从通信模型**
- 所有通信由主机发起
- 设备只能响应主机请求
- 采用轮询机制

### 5.2 端点（Endpoint）
端点是USB通信的基本单元：
- **端点0**：默认控制端点，双向，所有设备必须支持
- **端点1-15**：可配置为IN（设备到主机）或OUT（主机到设备）
- 每个端点有唯一地址：设备地址(7位) + 端点号(4位) + 方向(1位)

### 5.3 管道（Pipe）
管道是主机和设备端点之间的逻辑连接：
- **消息管道**：双向，用于控制传输
- **流管道**：单向，用于数据传输

## 6. USB传输类型

### 6.1 控制传输（Control Transfer）
- **用途**：配置设备、获取设备信息、发送命令
- **特点**：可靠、双向、有错误检测和重传
- **带宽**：低速10%，全速/高速20%
- **包结构**：Setup阶段 → Data阶段（可选）→ Status阶段

### 6.2 批量传输（Bulk Transfer）
- **用途**：大量数据传输（如U盘、打印机）
- **特点**：可靠、错误检测、无时间保证
- **支持**：仅全速和高速设备
- **包大小**：全速8/16/32/64字节，高速512字节

### 6.3 中断传输（Interrupt Transfer）
- **用途**：少量、低延迟数据（如鼠标、键盘）
- **特点**：周期性轮询、有限延迟、可靠传输
- **轮询间隔**：1ms-255ms（低速/全速），125μs-4s（高速）
- **包大小**：低速最大8字节，全速最大64字节，高速最大1024字节

### 6.4 同步传输（Isochronous Transfer）
- **用途**：实时数据（如音频、视频）
- **特点**：周期性、有带宽保证、无重传
- **带宽**：最多可占90%
- **包大小**：全速最大1023字节，高速最大1024字节

## 7. USB设备类别

### 7.1 标准设备类
| 类代码 | 类名称 | 典型设备 |
|--------|--------|----------|
| 0x01 | Audio | 音频设备 |
| 0x02 | CDC | 通信设备（调制解调器） |
| 0x03 | HID | 人机接口（键盘、鼠标） |
| 0x05 | Physical | 物理设备 |
| 0x06 | Image | 图像设备（相机、扫描仪） |
| 0x07 | Printer | 打印机 |
| 0x08 | Mass Storage | 存储设备（U盘、硬盘） |
| 0x09 | Hub | USB集线器 |
| 0x0A | CDC-Data | CDC数据 |
| 0x0B | Smart Card | 智能卡 |
| 0x0D | Content Security | 内容安全 |
| 0x0E | Video | 视频设备（摄像头） |

### 7.2 厂商特定类（Vendor Specific）
- 类代码：0xFF
- 需要专门的驱动程序
- 用于专有协议和设备

## 8. USB描述符

### 8.1 描述符类型
```c
/* USB描述符类型定义 */
#define USB_DT_DEVICE                0x01  // 设备描述符
#define USB_DT_CONFIG                0x02  // 配置描述符
#define USB_DT_STRING                0x03  // 字符串描述符
#define USB_DT_INTERFACE             0x04  // 接口描述符
#define USB_DT_ENDPOINT              0x05  // 端点描述符
#define USB_DT_DEVICE_QUALIFIER      0x06  // 设备限定描述符
#define USB_DT_OTHER_SPEED_CONFIG    0x07  // 其他速度配置描述符
#define USB_DT_INTERFACE_POWER       0x08  // 接口功率描述符
```

### 8.2 描述符层次结构
```
设备描述符（Device Descriptor）
    └── 配置描述符（Configuration Descriptor）
        ├── 接口描述符（Interface Descriptor）
        │   ├── 端点描述符（Endpoint Descriptor）
        │   └── 端点描述符（Endpoint Descriptor）
        └── 接口描述符（Interface Descriptor）
            └── 端点描述符（Endpoint Descriptor）
```

### 8.3 设备描述符示例
```c
struct usb_device_descriptor {
    __u8  bLength;              // 描述符长度（18字节）
    __u8  bDescriptorType;      // 描述符类型（0x01）
    __le16 bcdUSB;              // USB规范版本（如0x0200表示USB 2.0）
    __u8  bDeviceClass;         // 设备类代码
    __u8  bDeviceSubClass;      // 设备子类代码
    __u8  bDeviceProtocol;      // 设备协议代码
    __u8  bMaxPacketSize0;      // 端点0最大包大小
    __le16 idVendor;            // 厂商ID（VID）
    __le16 idProduct;           // 产品ID（PID）
    __le16 bcdDevice;           // 设备版本号
    __u8  iManufacturer;        // 制造商字符串索引
    __u8  iProduct;             // 产品字符串索引
    __u8  iSerialNumber;        // 序列号字符串索引
    __u8  bNumConfigurations;   // 配置数量
} __attribute__ ((packed));
```

## 9. USB枚举过程

### 9.1 枚举步骤详解
1. **设备连接检测**
   - Hub检测到设备连接（D+/D-线电平变化）
   - 向主机报告端口状态变化

2. **设备复位**
   - 主机发送复位信号（SE0状态持续10ms）
   - 设备进入默认状态，使用地址0

3. **获取设备描述符（前8字节）**
   - 主机发送GET_DESCRIPTOR请求
   - 获取端点0的最大包大小

4. **分配设备地址**
   - 主机发送SET_ADDRESS请求
   - 分配唯一地址（1-127）

5. **获取完整设备描述符**
   - 使用新地址通信
   - 获取18字节的完整设备描述符

6. **获取配置描述符**
   - 获取所有配置、接口、端点描述符
   - 了解设备功能和需求

7. **设置配置**
   - 主机发送SET_CONFIGURATION请求
   - 设备进入配置状态，准备工作

8. **加载驱动程序**
   - 根据VID/PID或类信息匹配驱动
   - 驱动接管设备控制

### 9.2 枚举时序图
```
主机                                设备
 |                                   |
 |-------- 复位信号（10ms）--------->|
 |                                   |
 |<------- 设备速度识别 -------------|
 |                                   |
 |-- GET_DESCRIPTOR(Device,64) ---->|
 |<------ 设备描述符(前8字节) -------|
 |                                   |
 |-------- 复位信号（10ms）--------->|
 |                                   |
 |---- SET_ADDRESS(addr=x) -------->|
 |<----------- ACK -----------------|
 |                                   |
 |-- GET_DESCRIPTOR(Device,18) ---->|
 |<------- 完整设备描述符 -----------|
 |                                   |
 |-- GET_DESCRIPTOR(Config,255) --->|
 |<------- 配置描述符集合 -----------|
 |                                   |
 |-- SET_CONFIGURATION(config=1) -->|
 |<----------- ACK -----------------|
 |                                   |
 |         设备就绪                  |
```

## 10. USB电源管理

### 10.1 供电方式
- **总线供电**：从USB端口获取电源
  - USB 2.0：最大500mA
  - USB 3.0：最大900mA
  - USB BC（Battery Charging）：最大1.5A

- **自供电**：设备自带电源
  - 仍需从总线获取少量电流（<100mA）
  - 在描述符中声明供电方式

### 10.2 电源状态
1. **Attached**：物理连接但未供电
2. **Powered**：已供电但未复位
3. **Default**：复位后，地址为0
4. **Address**：已分配唯一地址
5. **Configured**：已配置，正常工作
6. **Suspended**：挂起状态，低功耗

### 10.3 挂起和唤醒
- **自动挂起**：3ms无总线活动
- **远程唤醒**：设备主动唤醒主机
- **选择性挂起**：单个设备挂起

## 11. USB OTG（On-The-Go）

### 11.1 OTG概述
- 允许设备在主机和设备角色间切换
- 无需PC即可实现设备间直接通信
- 常见于手机、平板等移动设备

### 11.2 OTG特性
- **双角色设备**（DRD）：可作为主机或设备
- **主机协商协议**（HNP）：角色动态切换
- **会话请求协议**（SRP）：设备请求成为主机
- **Mini/Micro-AB接口**：支持两种插头

## 12. 常见问题与注意事项

### 12.1 硬件设计注意事项
- 差分信号线等长布线
- 避免过孔和拐角
- 正确的终端电阻匹配
- 充分的电源去耦

### 12.2 软件开发注意事项
- 严格遵循USB规范时序要求
- 正确处理各种错误情况
- 实现完整的描述符
- 注意端点FIFO管理

### 12.3 常见错误
- 设备无法枚举：检查描述符、电源、时序
- 传输错误：检查端点配置、缓冲区大小
- 设备不稳定：检查电源质量、信号完整性

## 13. 调试技巧

### 13.1 软件调试工具
```bash
# 查看USB设备列表
lsusb -v

# 查看USB设备树
lsusb -t

# 监控USB事件
udevadm monitor

# 查看内核USB日志
dmesg | grep -i usb

# USB设备详细信息
usb-devices
```

### 13.2 硬件调试
- 使用示波器查看D+/D-信号
- USB协议分析仪捕获数据包
- 检查电源电压和纹波

### 13.3 常用调试命令
```bash
# 绑定/解绑驱动
echo -n "1-1:1.0" > /sys/bus/usb/drivers/xxx/unbind
echo -n "1-1:1.0" > /sys/bus/usb/drivers/xxx/bind

# 重置USB设备
echo 0 > /sys/bus/usb/devices/1-1/authorized
echo 1 > /sys/bus/usb/devices/1-1/authorized

# 查看设备描述符
cat /sys/bus/usb/devices/1-1/descriptors | hexdump -C
```

## 总结

USB技术涵盖了从物理层到应用层的完整协议栈。作为Linux驱动开发人员，重点需要掌握：

1. **USB协议基础**：理解传输类型、描述符、枚举过程
2. **Linux USB架构**：熟悉USB Core、URB机制
3. **驱动开发流程**：probe/disconnect、数据传输
4. **调试方法**：使用各种工具定位问题

建议从简单的USB设备（如LED控制）开始实践，逐步深入到复杂的设备驱动开发。
