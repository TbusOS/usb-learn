# USB架构图和流程图详解（ASCII版）

## 🎯 概述

本文档通过ASCII字符绘制的架构图和流程图，直观展示USB系统的各个组成部分、数据流向和工作流程，帮助您深入理解USB技术的内部机制。

## 1. USB系统整体架构

### 1.1 USB系统分层架构图

```
                      USB系统分层架构
                      
┌─────────────────────────────────────────────────────────────┐
│                    用户应用程序                              │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   系统调用接口                               │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                  VFS虚拟文件系统                             │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    设备驱动层                                │
├─────────────┬─────────────┬─────────────┬─────────────────┤
│字符设备驱动 │块设备驱动   │网络设备驱动 │输入设备驱动     │
└─────────────┴─────────────┴─────────────┴─────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   USB设备驱动                                │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                  USB Core层 ★核心★                          │
├─────────────┬─────────────┬─────────────┬─────────────────┤
│  设备管理   │ 驱动匹配    │  URB管理    │   Hub驱动       │
│             │             │             │                 │
│  配置管理   │             │             │                 │
└─────────────┴─────────────┴─────────────┴─────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│              USB主机控制器驱动 (HCD)                         │
├─────────────┬─────────────┬─────────────┬─────────────────┤
│ EHCI驱动    │ XHCI驱动    │ OHCI驱动    │   UHCI驱动      │
│ (USB 2.0)   │ (USB 3.0)   │ (USB 1.1)   │  (USB 1.1)      │
└─────────────┴─────────────┴─────────────┴─────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                USB主机控制器硬件                             │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    USB总线                                   │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   USB设备                                    │
├─────────────┬─────────────┬─────────────┬─────────────────┤
│ 设备端点0   │ 其他端点    │ 设备功能    │                 │
└─────────────┴─────────────┴─────────────┴─────────────────┘
```

### 1.2 Linux USB子系统架构

```
                    Linux USB子系统架构
                    
            ┌─── 用户空间 ───┐
            │               │
            ▼               ▼               
    ┌──────────────┐ ┌──────────────┐ ┌──────────────┐
    │  应用程序    │ │  libusb库    │ │  系统工具    │
    └──────────────┘ └──────────────┘ └──────────────┘
            │               │               │
═══════════╪═══════════════╪═══════════════╪══════════ 系统调用边界
            │               │               │
            ▼               ▼               ▼
    ┌─────────────────────────────────────────────────────────┐
    │                  设备文件系统                            │
    │        /dev/xxx    /sys/xxx    /proc/xxx               │
    └─────────────────────────────────────────────────────────┘
                              │
                              ▼
    ┌─────────────────────────────────────────────────────────┐
    │                 USB设备驱动层                            │
    ├──────────────┬──────────────┬──────────────┬───────────┤
    │USB存储驱动   │ USB HID驱动  │ USB网络驱动  │ 其他驱动  │
    │(usb-storage) │  (usbhid)    │  (usbnet)    │           │
    └──────────────┴──────────────┴──────────────┴───────────┘
                              │
                              ▼ [probe/disconnect]
    ┌─────────────────────────────────────────────────────────┐
    │                USB Core (核心层)                         │
    ├─────────────────────────────────────────────────────────┤
    │ ┌────────────┐ ┌────────────┐ ┌────────────┐          │
    │ │设备管理器  │ │驱动管理器  │ │URB管理器   │          │
    │ │·设备枚举  │ │·驱动注册  │ │·URB分配   │          │
    │ │·设备配置  │ │·驱动匹配  │ │·URB提交   │          │
    │ │·电源管理  │ │·probe调用  │ │·URB完成   │          │
    │ └────────────┘ └────────────┘ └────────────┘          │
    │                                                         │
    │ API: usb_submit_urb(), usb_control_msg()               │
    └─────────────────────────────────────────────────────────┘
                              │
                              ▼ [HCD接口]
    ┌─────────────────────────────────────────────────────────┐
    │              主机控制器驱动层 (HCD)                      │
    ├──────────────┬──────────────┬──────────────┬───────────┤
    │  EHCI HCD    │   XHCI HCD   │  OHCI HCD    │ UHCI HCD  │
    │  (USB 2.0)   │  (USB 3.0+)  │  (USB 1.1)   │(USB 1.1)  │
    └──────────────┴──────────────┴──────────────┴───────────┘
                              │
                              ▼ [寄存器操作]
    ┌─────────────────────────────────────────────────────────┐
    │                USB主机控制器硬件                         │
    └─────────────────────────────────────────────────────────┘
```

## 2. USB设备枚举流程

### 2.1 设备插入检测流程

```
       设备枚举时序图
       
USB设备    USB Hub    主机控制器   HCD驱动    USB Core    设备驱动
   │          │           │          │           │          │
   │ 设备插入  │           │          │           │          │
   ├─────────>│           │          │           │          │
   │          │ 端口状态  │          │           │          │
   │          │  变化     │          │           │          │
   │          ├──────────>│          │           │          │
   │          │           │ 产生中断 │           │          │
   │          │           ├─────────>│           │          │
   │          │           │          │报告状态   │          │
   │          │           │          │  变化     │          │
   │          │           │          ├──────────>│          │
   │          │<──────────│<─────────│<──────────│          │
   │ 复位信号  │           │          │           │          │
   │<─────────│           │          │           │          │
   │          │           │          │           │          │
   │ 速度检测  │           │          │           │          │
   ├─────────>│──────────>│─────────>│──────────>│          │
   │          │           │          │           │          │
   │GET_DESC  │           │          │           │          │
   │<─────────│<──────────│<─────────│<──────────│          │
   │ 8字节    │           │          │           │          │
   ├─────────>│──────────>│─────────>│──────────>│          │
   │          │           │          │           │          │
   │SET_ADDR  │           │          │           │          │
   │<─────────│<──────────│<─────────│<──────────│          │
   │   ACK    │           │          │           │          │
   ├─────────>│──────────>│─────────>│──────────>│          │
   │          │           │          │           │          │
   │GET_DESC  │           │          │           │          │
   │<─────────│<──────────│<─────────│<──────────│          │
   │完整描述符 │           │          │           │          │
   ├─────────>│──────────>│─────────>│──────────>│          │
   │          │           │          │           │驱动匹配  │
   │          │           │          │           ├─────────>│
   │          │           │          │           │ probe()  │
   │          │           │          │           │<─────────│
   │SET_CONFIG│           │          │           │          │
   │<─────────│<──────────│<─────────│<──────────│<─────────│
   │   ACK    │           │          │           │          │
   ├─────────>│──────────>│─────────>│──────────>│─────────>│
   │          │           │          │           │          │
   │          │           │     设备就绪          │          │
```

### 2.2 设备状态机

```
                USB设备状态转换图
                
    [设备未连接] ────插入────> [已连接]
         ▲                       │
         │                       │ Hub供电
         │                       ▼
    [设备断开]                [已供电]
         ▲                       │
         │                       │ 收到复位
         │                       ▼
         │                   [默认状态]
         │                   地址=0，端点0
         │                       │
         │                       │ SET_ADDRESS
         │                       ▼
         │                   [地址状态]  
         │                   有唯一地址
         │                       │
         │                       │ SET_CONFIG
         │                       ▼
         │                   [已配置状态] ←──┐
         │                   完全可用        │
         │                       │          │恢复
         │                       │挂起      │
         │                       ▼          │
         │                   [挂起状态] ────┘
         │                   3ms无SOF
         │                       │
         └───────────────────────┘
              复位或断开
```

## 3. USB数据传输流程

### 3.1 控制传输流程

```
                    控制传输三阶段
                    
应用程序    驱动      USB Core    HCD       USB设备
   │         │          │          │           │
   │控制请求 │          │          │           │
   ├────────>│          │          │           │
   │         │创建URB   │          │           │
   │         ├─────────>│          │           │
   │         │          │Setup事务 │           │
   │         │          ├─────────>│           │
   │         │          │          │SETUP令牌  │
   │         │          │          ├──────────>│
   │         │          │          │Setup数据  │
   │         │          │          ├──────────>│
   │         │          │          │    ACK    │
   │         │          │          │<──────────┤
   │         │          │          │           │
   │         │          │Data事务  │           │
   │         │          │(可选)    │           │
   │         │          ├─────────>│           │
   │         │          │          │OUT/IN令牌 │
   │         │          │          ├──────────>│
   │         │          │          │   数据    │
   │         │          │          │<──────────┤
   │         │          │          │   ACK     │
   │         │          │          ├──────────>│
   │         │          │          │           │
   │         │          │Status事务│           │
   │         │          ├─────────>│           │
   │         │          │          │Status令牌 │
   │         │          │          ├──────────>│
   │         │          │          │    ACK    │
   │         │          │          │<──────────┤
   │         │URB完成   │          │           │
   │         │<─────────┤          │           │
   │请求完成 │          │          │           │
   │<────────┤          │          │           │
```

### 3.2 批量传输流程

```
              批量传输流程（写操作）
              
 应用程序      驱动        USB Core      HCD         设备
     │          │            │           │            │
     │write()   │            │           │            │
     ├─────────>│            │           │            │
     │          │创建批量URB │           │            │
     │          ├───────────>│           │            │
     │          │            │调度传输   │            │
     │          │            ├──────────>│            │
     │          │            │           │OUT令牌     │
     │          │            │           ├───────────>│
     │          │            │           │数据包      │
     │          │            │           ├───────────>│
     │          │            │           │   ACK      │
     │          │            │           │<───────────┤
     │          │            │           │            │
     │          │            │           │下一个包... │
     │          │            │           │            │
     │          │            │URB完成    │            │
     │          │            │<──────────┤            │
     │          │完成回调    │           │            │
     │          │<───────────┤           │            │
     │write返回 │            │           │            │
     │<─────────┤            │           │            │


              批量传输流程（读操作）
              
 应用程序      驱动        USB Core      HCD         设备
     │          │            │           │            │
     │ read()   │            │           │            │
     ├─────────>│            │           │            │
     │          │创建批量URB │           │            │
     │          ├───────────>│           │            │
     │          │            │调度传输   │            │
     │          │            ├──────────>│            │
     │          │            │           │IN令牌      │
     │          │            │           ├───────────>│
     │          │            │           │数据包      │
     │          │            │           │<───────────┤
     │          │            │           │   ACK      │
     │          │            │           ├───────────>│
     │          │            │           │            │
     │          │            │URB完成    │            │
     │          │            │<──────────┤            │
     │          │完成回调    │           │            │
     │          │<───────────┤           │            │
     │read返回  │            │           │            │
     │<─────────┤            │           │            │
```

## 4. URB生命周期

### 4.1 URB状态转换

```
                    URB状态转换图
                    
    [创建] usb_alloc_urb()
       │
       ▼ usb_fill_xxx_urb()
    [已初始化]
       │
       ▼ usb_submit_urb()
    [已提交] ────┐
       │        │
       ▼        │usb_unlink_urb()
    [处理中]     │
       │        │
       ▼        ▼
    [已完成]  [已取消]
       │        │
       ▼        ▼
    [释放] usb_free_urb()
```

### 4.2 URB处理流程

```
                     URB处理详细流程
                     
   驱动        USB Core        HCD层         硬件
     │             │            │             │
     │创建URB      │            │             │
     ├────────────>│            │             │
     │填充参数     │            │             │
     ├────────────>│            │             │
     │提交URB      │            │             │
     ├────────────>│            │             │
     │             │参数验证    │             │
     │             ├───────────>│             │
     │             │            │加入队列     │
     │             │            ├────────────>│
     │             │            │             │启动传输
     │             │            │             ├──────>USB总线
     │             │            │             │
     │             │            │硬件中断     │<──────USB设备响应
     │             │            │<────────────┤
     │             │            │中断处理     │
     │             │URB完成回调 │             │
     │             │<───────────┤             │
     │complete()   │            │             │
     │<────────────┤            │             │
```

## 5. USB Hub工作原理

### 5.1 Hub内部结构

```
                    USB Hub内部架构
                    
┌────────────────────────────────────────────────────────────┐
│                      USB Hub                               │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  ┌──────────────┐      ┌─────────────────────────────┐    │
│  │   Hub控制器  │      │      端口控制器阵列         │    │
│  │              │      │                             │    │
│  │ ·状态管理   │      │  ┌─────┐ ┌─────┐ ┌─────┐     │    │
│  │ ·事务处理   │<────>│  │端口1│ │端口2│ │端口3│     │    │
│  │ ·错误检测   │      │  │控制 │ │控制 │ │控制 │     │    │
│  │              │      │  └─────┘ └─────┘ └─────┘     │    │
│  └──────────────┘      └─────────────────────────────┘    │
│         ▲                                                  │
│         │                                                  │
│  ┌──────▼──────┐      ┌─────────────────────────────┐    │
│  │ 上行端口    │      │      电源管理单元           │    │
│  │ 控制器      │      │                             │    │
│  │             │      │ ·电源分配  ·过流保护       │    │
│  │ ·与主机通信│      │ ·电源切换  ·电源指示       │    │
│  └─────────────┘      └─────────────────────────────┘    │
│                                                            │
└────────────────────────────────────────────────────────────┘
                        │
                        ▼
            ┌─── 到USB设备 ───┐
            │               │
            ▼               ▼
    ┌──────────────┐ ┌──────────────┐
    │   设备1      │ │   设备2      │
    └──────────────┘ └──────────────┘
```

### 5.2 Hub事务处理

```
                    Hub事务处理流程
                    
    主机                Hub               下游设备
      │                  │                   │
      │ 事务到端口2       │                   │
      ├─────────────────>│                   │
      │                  │ 解析目标端口      │
      │                  │ 转发到端口2      │
      │                  ├─────────────────>│
      │                  │                   │处理事务
      │                  │ 接收响应          │
      │                  │<─────────────────┤
      │ 转发响应         │                   │
      │<─────────────────┤                   │
      │                  │                   │
      
                Hub中继处理特点:
                1. 信号再生和放大
                2. 错误检测和隔离  
                3. 电源管理
                4. 状态监控
```

## 6. USB错误处理架构

### 6.1 错误检测和恢复流程

```
                    USB错误处理流程
                    
    传输错误
        │
        ▼
    ┌─────────────┐
    │错误类型判断 │
    └─────────────┘
        │
        ├── CRC错误 ────────> 自动重传 ────┐
        │                                 │
        ├── 超时错误 ──────> 重新尝试 ────┤
        │                                 │
        ├── STALL错误 ────> 清除端点停止 ─┤
        │                                 │
        ├── 设备无响应 ──> 设备复位 ──────┤
        │                                 │
        └── 严重错误 ────> 设备断开 ──────┘
                                          │
                                          ▼
                                    ┌─────────────┐
                                    │错误恢复策略 │
                                    └─────────────┘
                                          │
        ┌─────────────────────────────────┼─────────────────┐
        │                                 │                 │
        ▼                                 ▼                 ▼
    [继续传输]                      [重新初始化]        [通知上层]
```

### 6.2 多层错误处理

```
              USB多层错误处理架构
              
┌─────────────────────────────────────────────────────────┐
│                  应用层                                  │
│ ·用户异常处理  ·重试机制  ·优雅降级                     │
└─────────────────────────────────────────────────────────┘
                          ▲
                          │ 错误上报
                          │
┌─────────────────────────────────────────────────────────┐
│                  驱动层                                  │
│ ·URB状态检查  ·设备监控  ·资源清理                      │
└─────────────────────────────────────────────────────────┘
                          ▲
                          │ 错误传递
                          │
┌─────────────────────────────────────────────────────────┐
│                USB Core层                                │
│ ·传输错误检测  ·设备重枚举  ·端点复位                   │
└─────────────────────────────────────────────────────────┘
                          ▲
                          │ 硬件错误
                          │
┌─────────────────────────────────────────────────────────┐
│                 硬件层                                   │
│ ·CRC检测  ·超时检测  ·电气错误  ·自动重传              │
└─────────────────────────────────────────────────────────┘
```

## 总结

通过这些ASCII字符绘制的架构图和流程图，我们清晰展示了：

1. **系统架构**：从应用层到硬件层的完整视图
2. **设备枚举**：详细的时序和状态转换
3. **数据传输**：各种传输类型的具体流程
4. **URB机制**：USB请求块的生命周期
5. **Hub原理**：集线器的内部结构和工作方式
6. **错误处理**：多层次的错误检测和恢复机制

这些图表为USB驱动开发提供了直观的参考，所有图表都使用ASCII字符绘制，可以在任何文本编辑器中直接查看，无需特殊软件。
